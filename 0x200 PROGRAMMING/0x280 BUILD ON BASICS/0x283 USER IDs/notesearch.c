#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/stat.h>
#include "hacking.h"

#define FILENAME "/var/notes"

int print_notes( int, int, char * );
int find_user_note( int, int );
int search_note( char *, char * );

int main( int argc, char *argv[] )
{
    int uid,fd,print=1;
    char searchstr[100];
    
    if ( argc > 1 )                        // use argv[1] if commandline arg
        strcpy( searchstr,argv[1] );       // is passed
    else                                   // else nothing to search  
        searchstr[0] = 0;
    
    uid = getuid();
    fd = open( FILENAME, O_RDONLY );
    if ( fd == -1 )
        prnerr("in main() while opening file for reading");
    
    while( print )
        print = print_notes( fd, uid, searchstr );
    printf("---------------[ END OF NOTES ]---------------------\n");
    close(fd);
}

// Function to print the notes for the given UID return 0 if 
// EOF is reached else return 1

int print_notes( int fd, int uid, char *searchstr )
{
    int note_len;
    char byte = 0;
    char note_buffer[100];
    
    note_len = find_user_note( fd, uid );
    if ( note_len < 0 )                          // check if EOF is reached
        return 0;
    printf("[DEBUG] note len in print() %d",note_len);
    read(fd,&note_buffer,note_len);             // read note_len(size) into note_buffer
    note_buffer[note_len] = 0;                  // terminate with 0
    printf(note_buffer);                      
    
    if ( search_note( note_buffer,searchstr ) )     // search for a given search string
        printf(note_buffer);                        // print the notes read from the file
 
    return 1;
}


// Function to find the length of the note 
// return -1 if EOF is seen else send the length

int find_user_note( int fd, int uid )    
{
    int note_uid = -1;
    unsigned char byte;
    int length;
    
    while ( note_uid != uid )                       // loop until specified uid is found
    {
        if ( read( fd, &note_uid, 4 ) != 4 )        // read 4 bytes of uid
            return -1;                              // EOF if not readable
        if ( read( fd, &byte, 1 ) != 1 )            // read the '/n' newline char
            return -1;                              // EOF if unavailable
        
        byte = length = 0;
        
        while ( byte != '\n' )                      // iterate till EOF
        {
            if ( read( fd, &byte, 1 ) != 1 )        // read byte by byte
                return -1;                          // return EOF if unreadable
            length++;
         }
    } 
    
    lseek( fd, length * -1, SEEK_CUR );            // rewind cursor to start postion
    
    printf("[DEBUG] Found %d bytes of notes for the UID %d \n",length,note_uid);
    printf("[DEBUG] printing length in find() %d\n",length);
    return length;
}

// Function to search a given keyword 1 if found
// else 0

int search_note( char *note, char *keyword )
{
    int i,key_len,match = 0;
    
    key_len = strlen(keyword);
    if ( key_len == 0 )                           // if no string to search
        return 1;                                 // it is 100% match 
    
    for( i = 0; i < strlen(note); i++ )           // iterate byte by byte till end of notes
    {
        if ( note[i] == keyword[match] )         // if byte matches keyword  
            match++;                             // start counting the match
        else if ( note[i] == keyword[0] )        // if it matches first key byte start match from q
            match = 1;
        else
            match = 0;                           // else start from 0
        if ( match == key_len )
            return 1;                            // return if matches fully
    }
    
    return 0;
}
